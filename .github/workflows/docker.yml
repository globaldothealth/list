# Action that verifies the epid Docker compose stack can run.

name: Docker compose up

on:
  pull_request:
    branches: [master]
    paths:
      - ".github/workflows/docker.yml"
      - "data-serving/data-service/**"
      - "verification/curator-service/**"

jobs:
  test-dev:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build stack
        run: docker-compose -f dev/docker-compose.yml -f dev/docker-compose.ci.yml up --build -d -V
      # Containers are run detached above, which means we have to wait until they are up to produce meaningful logs.
      - name: Sleep for 30 seconds
        uses: jakejarvis/wait-action@master
        with:
          time: "30s"
      - name: Print logs
        run: docker-compose -f dev/docker-compose.yml logs
      - name: Fetch Curator Service sources
        run: docker-compose -f dev/docker-compose.yml exec -T curator curl --retry-connrefused --retry 20 --retry-delay 5 -f --silent --show-error http://localhost:3001/api/sources
      - name: Test Data Service cases
        run: docker-compose -f dev/docker-compose.yml exec -T data curl --retry-connrefused --retry 20 --retry-delay 5 -f --silent --show-error http://localhost:3000/api/cases
